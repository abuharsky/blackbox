# Внутреннее устройство (RU)

Этот документ — про дизайн-инварианты и типовые «почему так», полезные при тестировании и расширении библиотеки.

## Почему compute может вызываться больше одного раза

Библиотека не фиксирует контракт «один event → один compute».

Причины многократных вычислений:
- подписка (`listen`) может инициировать актуализацию output;
- подписка на dependency часто приводит к синхронной эмиссии «текущего значения», что может триггерить дополнительный pump;
- планировщик может делать повторные попытки вычисления после transient ошибок (если `onError` swallow);
- дедупликации могут быть реализованы иначе в будущих версиях (поэтому тесты не должны фиксировать точные counts, если это не часть спецификации).

**Правильный подход для тестов:** проверять финальные состояния (`output`) и корректность реакций на изменения.

---

## Планирование (pump / schedule)

Graph обычно работает так:
1. при добавлении узла/подписке/обновлении output вызывается `_schedulePump`;
2. `_schedulePump` приводит к `_pump`;
3. `_pump` проходит по узлам и вызывает `tryCompute`;
4. `tryCompute` строит input через `DependencyResolver` и вычисляет output.

Важно: `addWithDependencies(...)` обычно **сразу инициирует pump**, поэтому ошибки из dependency могут возникать уже в момент add, а не «потом».

---

## onError и transient ошибки

`onError` предназначен для:
- async readiness (`AsyncLoading`),
- временных ошибок внешних систем,
- сценариев, где узел «может жить» без результата до тех пор, пока dependencies не станут валидными.

`onError` **не** означает, что вычисление не будет попытано; он лишь управляет тем, фатальна ошибка или нет.

---

## CancelFn

CancelFn должен быть идемпотентным (повторный вызов безопасен).
Если вы видите повторные cancel-вызовы — это нормальный сценарий (например, в dispose/cleanup цепочках).

---

## Типовые дизайн-решения

- Fail-fast по умолчанию (ошибка — это сигнал о нарушении инварианта).
- Opt-in для «мягкой» деградации (через onError).
- Слабые типы на внутренних границах (например, базовый Output) и более строгие — на публичном API (например, SyncOutput для sync box).
